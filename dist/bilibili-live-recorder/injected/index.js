/*!
 * bilibili-live-recorder v2.0.5
 * Github: undefined
 * (c) 2018-2019 Harvey Zack
 * Released under the MIT License.
 */

var bilibiliLiveRecorderInjected=function(){"use strict";function e(e,t){return e(t={exports:{}},t.exports),t.exports}var t=e((function(e){function t(r,n){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(r,n)}e.exports=t})),r=e((function(e){function r(n,a,i){return!function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?e.exports=r=function(e,r,n){var a=[null];a.push.apply(a,r);var i=new(Function.bind.apply(e,a));return n&&t(i,n.prototype),i}:e.exports=r=Reflect.construct,r.apply(null,arguments)}e.exports=r}));var n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var i=function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e};function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise((function(t){return setTimeout(t,e)}))}var s=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}var l=function(){function e(t){n(this,e),this.name=t}return i(e,[{key:"get",value:function(e){var t=JSON.parse(window.localStorage.getItem(this.name))||{};return e?t[e]:t}},{key:"set",value:function(e,t){var r=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(r,!0).forEach((function(t){s(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(r).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},this.get(),s({},e,t));window.localStorage.setItem(this.name,JSON.stringify(r))}},{key:"del",value:function(e){var t=this.get();delete t[e],window.localStorage.setItem(this.name,JSON.stringify(t))}},{key:"clean",value:function(){window.localStorage.removeItem(this.name)}}]),e}();return new(function(){function e(){var t=this;n(this,e),this.name="bilibili-live-recorder",this.storage=new l(this.name),this.worker=new Worker(URL.createObjectURL(new Blob(['"use strict";function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function mergeBuffer(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];var d=b[0].constructor;return b.reduce(function(a,b){var c=new d((0|a.byteLength)+(0|b.byteLength));return c.set(a,0),c.set(b,0|a.byteLength),c},new d)}function readBufferSum(a){var b=!(1<arguments.length&&arguments[1]!==void 0)||arguments[1];return a.reduce(function(c,d,e){return c+(b?d:d-128)*Math.pow(256,a.length-e-1)},0)}function getTagTime(a){var b=a[4],c=a[5],d=a[6],e=a[7];return d|c<<8|b<<16|e<<24}function durationToTime(a){var b=(Math.floor(a/60)+"").slice(-5),c=a%60+"";return"".concat(1===b.length?"0".concat(b):b,":").concat(1===c.length?"0".concat(c):c)}var Flv=/*#__PURE__*/function(){function a(){_classCallCheck(this,a),this.index=0,this.tasks=[],this.timer=null,this.loading=!1,this.running=!1,this.tagLength=0,this.tagStartTime=0,this.resultDuration=0,this.data=new Uint8Array,this.header=new Uint8Array,this.scripTag=new Uint8Array,this.videoAndAudioTags=[],function a(){var b=this;this.timer=setTimeout(function(){b.running&&b.loading&&b.report(),a.call(b)},1e3)}.call(this)}return _createClass(a,[{key:"report",value:function report(){postMessage({type:"report",data:{duration:durationToTime(Math.floor(this.resultDuration/1e3)),size:"".concat((this.resultSize/1024/1024).toFixed(2).slice(-8),"M")}})}},{key:"readable",value:function readable(a){return this.data.length-this.index>=a}},{key:"read",value:function read(a){var b=this.index+a,c=this.data.subarray(this.index,b);return this.index=b,c}},{key:"load",value:function load(a){this.loading=!0,this.tasks.push(this.demuxer.bind(this,a)),this.running||function a(){var b=this,c=this.tasks.shift();c&&this.loading?(this.running=!0,c().then(function(){setTimeout(a.bind(b),0)})):this.running=!1}.call(this)}},{key:"demuxer",value:function demuxer(a){var b=this;return new Promise(function(c,d){if(!b.loading)return void c();for(b.data=mergeBuffer(b.data,a),!b.header.length&&b.readable(13)&&(b.header=b.read(13));b.index<b.data.length;){var e=0,f=0,g=new Uint8Array,h=b.index;if(b.readable(11))g=mergeBuffer(g,b.read(11)),f=g[0],e=readBufferSum(g.subarray(1,4));else return b.index=h,void c();if(b.readable(e+4)){g=mergeBuffer(g,b.read(e));var i=b.read(4);g=mergeBuffer(g,i);var j=readBufferSum(i);if(j!==e+11)return b.stop(),postMessage({type:"error"}),void d(new Error("Bilibili 录播姬: 视频流发生变化，已自动停止录制"))}else return b.index=h,void c();if(b.tagLength+=1,18===f)b.scripTag=g;else{var k=getTagTime(g);b.tagStartTime||(b.tagStartTime=k);var l=k-b.tagStartTime;10>=b.tagLength&&1e3<=l-b.resultDuration&&(b.tagStartTime=k),b.resultDuration=k-b.tagStartTime;var m=b.videoAndAudioTags[b.videoAndAudioTags.length-1];m?10485760<=m.byteLength?b.videoAndAudioTags.push(g):b.videoAndAudioTags[b.videoAndAudioTags.length-1]=mergeBuffer(m,g):b.videoAndAudioTags.push(g)}b.data=b.data.subarray(b.index),b.index=0}c()})}},{key:"stop",value:function stop(){this.loading=!1,clearTimeout(this.timer),this.report()}},{key:"download",value:function download(){postMessage({type:"download",data:URL.createObjectURL(new Blob([this.resultData]))})}},{key:"resultData",get:function get(){return mergeBuffer.apply(void 0,[this.header,this.scripTag].concat(_toConsumableArray(this.videoAndAudioTags)))}},{key:"resultSize",get:function get(){return this.header.byteLength+this.scripTag.byteLength+this.videoAndAudioTags.reduce(function(a,b){return a+b.byteLength},0)}}]),a}(),flv=new Flv;onmessage=function onmessage(a){var b=a.data,c=b.type,d=b.data;switch(c){case"load":flv.load(d);break;case"stop":flv.stop();break;case"download":flv.download();break;default:}};']))),this.loading=!1,this.worker.onmessage=function(e){var r,n,a,i=e.data,o=i.type,s=i.data;switch(o){case"report":t.$container&&(t.$duration.textContent=s.duration,t.$size.textContent=s.size);break;case"download":r=s,n="".concat(document.title,".flv"),(a=document.createElement("a")).style.display="none",a.href=r,a.download=n,document.body.appendChild(a),a.click(),document.body.removeChild(a),t.changeState("before-record"),t.worker.terminate(),t.$duration.textContent="00:00",t.$size.textContent="0.00M";break;case"error":t.loading=!1,t.changeState("after-record")}},this.storage.get(location.href)&&(this.storage.del(location.href),this.loading=!0,this.intercept()),o(1e3).then((function(){t.createUI(),t.analysis()}))}return i(e,[{key:"createUI",value:function(){var e=this;if(!document.body)return o(100).then((function(){return e.createUI()}));this.$container=document.createElement("div"),this.$container.classList.add(this.name),this.$container.innerHTML='\n            <div class="blr-states">\n                <div class="blr-state blr-state-before-record blr-active">开始</div>\n                <div class="blr-state blr-state-recording">停止</div>\n                <div class="blr-state blr-state-after-record">下载</div>\n                <div class="blr-state blr-state-wait">稍等</div>\n            </div>\n            <div class="blr-monitors">\n                <div class="blr-monitor blr-monitor-top">\n                    <div class="blr-monitor-name">时长：</div>\n                    <div class="blr-monitor-value blr-duration">00:00</div>\n                </div>\n                <div class="blr-monitor blr-monitor-bottom">\n                    <div class="blr-monitor-name">大小：</div>\n                    <div class="blr-monitor-value blr-size">0.00M</div>\n                </div>\n            </div>\n        ',this.$states=Array.from(this.$container.querySelectorAll(".blr-state")),this.$beforeRecord=this.$container.querySelector(".blr-state-before-record"),this.$recording=this.$container.querySelector(".blr-state-recording"),this.$afterRecord=this.$container.querySelector(".blr-state-after-record"),this.$duration=this.$container.querySelector(".blr-duration"),this.$size=this.$container.querySelector(".blr-size"),this.$monitor=this.$container.querySelector(".blr-monitor"),this.loading?this.changeState("recording"):location.href.includes("blr")&&(this.storage.clean(),this.$container.classList.add("blr-focus"),o(1e4).then((function(){e.$container.classList.remove("blr-focus")})));var t=this.storage.get("x"),r=this.storage.get("y");t&&r&&(this.$container.style.left="".concat(t,"px"),this.$container.style.top="".concat(r,"px")),document.body.appendChild(this.$container),this.bindEvent()}},{key:"changeState",value:function(e){this.$states.forEach((function(t){t.classList.contains("blr-state-".concat(e))?t.classList.add("blr-active"):t.classList.remove("blr-active")}))}},{key:"bindEvent",value:function(){var e=this;this.$beforeRecord.addEventListener("click",(function(){document.querySelector("video")&&(e.storage.set(location.href,Date.now()),location.reload())})),this.$recording.addEventListener("click",(function(){e.loading=!1,e.changeState("after-record"),e.worker.postMessage({type:"stop"})})),this.$afterRecord.addEventListener("click",(function(){e.loading=!1,e.changeState("wait"),e.worker.postMessage({type:"download"})}));var t=!1,r=0,n=0,a=0,i=0;this.$monitor.addEventListener("mousedown",(function(){t=!0,r=event.pageX,n=event.pageY,a=e.$container.offsetLeft,i=e.$container.offsetTop})),document.addEventListener("mousemove",(function(a){if(t){var i=a.pageX-r,o=a.pageY-n;e.$container.style.transform="translate(".concat(i,"px, ").concat(o,"px)")}})),document.addEventListener("mouseup",(function(){if(t){t=!1,e.$container.style.transform="translate(0, 0)";var o=a+event.pageX-r,s=i+event.pageY-n;e.$container.style.left="".concat(o,"px"),e.$container.style.top="".concat(s,"px"),e.storage.set("x",o),e.storage.set("y",s)}}))}},{key:"intercept",value:function(){var e=this,t=ReadableStreamDefaultReader.prototype.read;ReadableStreamDefaultReader.prototype.read=function(){var r=t.call(this);return r.then((function(t){var r=t.done,n=t.value;!r&&e.loading&&e.worker.postMessage({type:"load",data:n})})),r};var n=window.Blob;window.Blob=function(e,t){var r=e[0];return t&&"text/javascript"===t.type&&(r='var read=ReadableStreamDefaultReader.prototype.read;ReadableStreamDefaultReader.prototype.read=function(){var e=read.call(this);return e.then(function(e){postMessage({type:"blr-load",data:e})}),e};\n'.concat(r)),new n([r],t)};var a=window.Worker;window.Worker=function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];if("data:"!==n[0].slice(0,5)){var o=r(a,n);return o.onmessage=function(t){var r=t.data,n=r.type,a=r.data;switch(n){case"blr-load":if(a.done||!e.loading)return;e.worker.postMessage({type:"load",data:a.value})}},o}}}},{key:"analysis",value:function(){window._hmt=window._hmt||[];var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?3c93ca28120f48d2a27889d0623cd7b7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}}]),e}())}();
