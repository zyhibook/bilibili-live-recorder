/*!
 * bilibili-live-recorder v1.0.1
 * Github: undefined
 * (c) 2018-2019 Harvey Zack
 * Released under the MIT License.
 */

!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).Background=n()}(this,(function(){"use strict";var e=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")};function n(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var t=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e};const r=e=>new Promise(n=>e.createReader().readEntries(e=>Promise.all(e.filter(e=>"."!==e.name[0]).map(e=>e.isDirectory?r(e):new Promise(n=>e.file(n)))).then(e=>[].concat(...e)).then(n))),o=(e,n)=>{(e=>r(e).then(e=>e.map(e=>e.name+e.lastModifiedDate).join()))(e).then(t=>{n&&n!==t?chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]&&chrome.tabs.reload(e[0].id),chrome.runtime.reload()}):setTimeout(()=>o(e,t),1e3)})};chrome.management.getSelf(e=>{"development"===e.installType&&chrome.runtime.getPackageDirectoryEntry(e=>o(e))});var i="notify";return new(function(){function n(){e(this,n),this.changeCSP(),chrome.runtime.onMessage.addListener((function(e){var n=e.type,t=e.data;switch(n){case i:chrome.notifications.create(String(Math.random()),{type:"basic",message:t.message,contextMessage:t.title||"",title:chrome.runtime.getManifest().name,iconUrl:chrome.extension.getURL("icons/icon128.png")})}})),chrome.notifications.onClicked.addListener((function(e){chrome.notifications.clear(e)}))}return t(n,[{key:"changeCSP",value:function(){chrome.webRequest.onHeadersReceived.addListener((function(e){var n=e.responseHeaders.find((function(e){return"content-security-policy-report-only"===e.name.toLowerCase()}));return n&&n.value&&(n.value="worker-src blob: ; "+n.value),{responseHeaders:e.responseHeaders}}),{urls:["*://*.bilibili.com/*"]},["blocking","responseHeaders"])}}]),n}())}));
