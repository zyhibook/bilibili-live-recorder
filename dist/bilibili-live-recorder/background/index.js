/*!
 * bilibili-live-recorder v1.0.2
 * Github: undefined
 * (c) 2018-2019 Harvey Zack
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Background=t()}(this,(function(){"use strict";var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var n=function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e};const r=e=>new Promise(t=>e.createReader().readEntries(e=>Promise.all(e.filter(e=>"."!==e.name[0]).map(e=>e.isDirectory?r(e):new Promise(t=>e.file(t)))).then(e=>[].concat(...e)).then(t))),o=(e,t)=>{(e=>r(e).then(e=>e.map(e=>e.name+e.lastModifiedDate).join()))(e).then(n=>{t&&t!==n?chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]&&chrome.tabs.reload(e[0].id),chrome.runtime.reload()}):setTimeout(()=>o(e,n),1e3)})};chrome.management.getSelf(e=>{"development"===e.installType&&chrome.runtime.getPackageDirectoryEntry(e=>o(e))});var a="recording",i="after_record",c="update_config",s="notify";return new(function(){function t(){var n=this;e(this,t),this.changeCSP(),chrome.runtime.onMessage.addListener((function(e){var t=e.type,r=e.data;switch(t){case s:chrome.notifications.create(String(Math.random()),{type:"basic",message:r.message,contextMessage:r.title||"",title:chrome.runtime.getManifest().name,iconUrl:chrome.extension.getURL("icons/icon128.png")});break;case c:r.state===a?n.setBadgeText(r.id,"ON"):r.state===i?n.setBadgeText(r.id,"OK"):n.setBadgeText(r.id,"")}})),chrome.notifications.onClicked.addListener((function(e){chrome.notifications.clear(e)}))}return n(t,[{key:"setBadgeText",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"#23ade5";chrome.browserAction.setBadgeText({text:String(t),tabId:e}),chrome.browserAction.setBadgeBackgroundColor({color:n})}},{key:"changeCSP",value:function(){chrome.webRequest.onHeadersReceived.addListener((function(e){var t=e.responseHeaders.find((function(e){return"content-security-policy-report-only"===e.name.toLowerCase()}));return t&&t.value&&(t.value="worker-src blob: ; "+t.value),{responseHeaders:e.responseHeaders}}),{urls:["*://*.bilibili.com/*"]},["blocking","responseHeaders"])}}]),t}())}));
