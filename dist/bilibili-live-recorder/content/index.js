/*!
 * bilibili-live-recorder v1.0.0
 * Github: undefined
 * (c) 2018-2019 Harvey Zack
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Content=t()}(this,(function(){"use strict";var e=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var o=function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e};function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise((function(t){return setTimeout(t,e)}))}var a="https://live.bilibili.com",c="before_record",i="tab_info",s="start_record",u="stop_record",d="start_download",f="update_config",g="mp4_buffer",l="flv_buffer",p="notify";function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}return new(function(){function n(){var e=this;t(this,n),this.injectScript(),this.injectStyle(),this.tab=null,this.config=null,this.worker=new Worker(URL.createObjectURL(new Blob(['"use strict";var NOTIFY="notify",FLV_BUFFER="flv_buffer",STOP_RECORD="stop_record",START_RECORD="start_record",UPDATE_CONFIG="update_config",START_DOWNLOAD="start_download",config=null,recording=!1,videoDate=new Uint8Array(1048576),debugStr="";function debugLog(){for(var a=new Date,b="".concat(a.getHours(),":").concat(a.getMinutes(),":").concat(a.getSeconds()),c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];debugStr="".concat(debugStr,"\\n\\n").concat(b," -> ").concat(d.map(function(a){return JSON.stringify(a)}).join("|")).trim(),postMessage({type:UPDATE_CONFIG,data:{debug:debugStr}})}function notify(a){postMessage({type:NOTIFY,data:{title:config.name||"",message:a}})}onmessage=function onmessage(a){var b=a.data,c=b.type,d=b.data;switch(c){case FLV_BUFFER:break;case START_RECORD:recording=!0,config=d,debugStr="",config.debug="",notify(START_RECORD),debugLog(START_RECORD,config);break;case STOP_RECORD:{recording=!1,debugLog(STOP_RECORD);break}case START_DOWNLOAD:debugLog(START_DOWNLOAD),postMessage({type:START_DOWNLOAD,data:videoDate});break;default:}};']))),this.worker.onmessage=function(t){var n=t.data,o=n.type,r=n.data;switch(o){case p:e.notify(r);break;case f:e.updateConfig(r);break;case d:e.download(r)}},chrome.runtime.onMessage.addListener((function(t,n,o){var a=t.type,f=t.data;switch(a){case i:e.tab=f;break;case s:e.config=f,r(1e3).then((function(){document.querySelector("video")?e.worker.postMessage({type:s,data:f}):(e.notify({message:"未找到视频播放器"}),e.updateConfig({state:c}))}));break;case d:e.config=f,e.worker.postMessage({type:d,data:f});break;case u:e.config=f,e.worker.postMessage({type:u,data:f})}o(e.config)})),window.addEventListener("message",(function(t){if(t.origin===a){var n=t.data,o=n.type,r=n.data;switch(o){case g:break;case l:e.worker.postMessage({type:l,data:r})}}}))}return o(n,[{key:"download",value:function(e){!function(e,t){var n=document.createElement("a");n.style.display="none",n.href=e,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n)}(URL.createObjectURL(new Blob([e])),this.config.name+"."+this.config.format)}},{key:"notify",value:function(e){chrome.runtime.sendMessage({type:p,data:e})}},{key:"updateConfig",value:function(t){this.config=function(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?b(o,!0).forEach((function(n){e(t,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):b(o).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}({},this.config,{},t),chrome.runtime.sendMessage({type:f,data:this.config})}},{key:"injectScript",value:function(){var e=document.createElement("script");e.src=chrome.extension.getURL("injected/index.js"),e.onload=function(){return e.remove()},document.documentElement.appendChild(e)}},{key:"injectStyle",value:function(){var e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.href=chrome.extension.getURL("injected/index.css"),r().then((function(){return document.head.appendChild(e)}))}}]),n}())}));
