/*!
 * bilibili-live-recorder v1.0.3
 * Github: undefined
 * (c) 2018-2019 Harvey Zack
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Content=t()}(this,(function(){"use strict";var e=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function r(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var a=function(e,t,a){return t&&r(e.prototype,t),a&&r(e,a),e};function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}var i=function(){function r(e){t(this,r),this.name=e}return a(r,[{key:"get",value:function(e){var t=JSON.parse(window.localStorage.getItem(this.name))||{};return e?t[e]:t}},{key:"set",value:function(t,r){var a=function(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?n(a,!0).forEach((function(r){e(t,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):n(a).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}({},this.get(),e({},t,r));window.localStorage.setItem(this.name,JSON.stringify(a))}},{key:"del",value:function(e){var t=this.get();delete t[e],window.localStorage.setItem(this.name,JSON.stringify(t))}},{key:"clean",value:function(){window.localStorage.removeItem(this.name)}}]),r}(),o="https://live.bilibili.com",c="before_record",s="recording",u="tab_info",d="start_record",f="stop_record",l="start_download",g="update_config",h="mp4_buffer",b="flv_buffer",y="notify";function p(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}return new(function(){function r(){var e=this;t(this,r),this.injectScript(),this.injectStyle(),this.tab=null,this.worker=new Worker(URL.createObjectURL(new Blob(['"use strict";function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var NOTIFY="notify",FLV_BUFFER="flv_buffer",STOP_RECORD="stop_record",RESET_RECORD="reset_record",START_RECORD="start_record",AFTER_RECORD="after_record",UPDATE_CONFIG="update_config",START_DOWNLOAD="start_download",FLVParser=/*#__PURE__*/function(){function a(){var b=this;_classCallCheck(this,a),this.data=new Uint8Array,this.header=new Uint8Array,this.scripTag=new Uint8Array,this.videoAndAudioTags=new Uint8Array,this.tagStartTime=0,this.recordStartTime=0,this.resultDuration=0,this.recording=!1,this.config={},this.index=0,this.tasks=[],this.running=!1,this.downloadRate=a.createRate(function(a){b.recording&&postMessage({type:UPDATE_CONFIG,data:{downloadRate:a.toFixed(3)}})}),this.expectedSizeRate=a.createRate(function(a){b.recording&&postMessage({type:UPDATE_CONFIG,data:{expectedSize:a.toFixed(3)}})},!1),this.writeRate=a.createRate(function(a){b.recording&&postMessage({type:UPDATE_CONFIG,data:{writeRate:a.toFixed(3)}})}),this.durationRate=a.createRate(function(a){b.recording&&postMessage({type:UPDATE_CONFIG,data:{currentDuration:a.toFixed(3)}})},!1),this.sizeRate=a.createRate(function(a){b.recording&&postMessage({type:UPDATE_CONFIG,data:{currentSize:a.toFixed(3)}})},!1)}return _createClass(a,null,[{key:"mergeBuffer",value:function mergeBuffer(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++)b[c]=arguments[c];var d=b[0].constructor;return b.reduce(function(a,b){var c=new d((0|a.byteLength)+(0|b.byteLength));return c.set(a,0),c.set(b,0|a.byteLength),c},new d)}},{key:"readBufferSum",value:function readBufferSum(a){var b=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return a.reduce(function(c,d,e){return c+(b?d:d-128)*Math.pow(256,a.length-e-1)},0)}},{key:"numToFloat64Arr",value:function numToFloat64Arr(a){return _toConsumableArray(new Uint8Array(new Float64Array([a]).buffer)).reverse()}},{key:"readBufferString",value:function readBufferString(a){var b;return(b=String.fromCharCode).call.apply(b,[String].concat(_toConsumableArray(a)))}},{key:"getNowTime",value:function getNowTime(){return performance&&"function"==typeof performance.now?performance.now():Date.now()}},{key:"createRate",value:function createRate(b){var c=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],d=0,e=a.getNowTime();return function(){var f=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;d+=f;var g=a.getNowTime(),h=g-e;1e3<=h&&(b(c?1e3*(d/h):f),e=g,d=0)}}},{key:"getTagTime",value:function getTagTime(a){var b=a[4],c=a[5],d=a[6],e=a[7];return d|c<<8|b<<16|e<<24}},{key:"setTagTime",value:function setTagTime(a){var b=new Uint8Array(4),c=new Uint8Array(new Uint32Array([a]).buffer);return b[0]=c[2],b[1]=c[1],b[2]=c[0],b[3]=c[3],b}}]),_createClass(a,[{key:"notify",value:function notify(a){postMessage({type:NOTIFY,data:{title:this.config.name||"",message:a+""}})}},{key:"readable",value:function readable(a){return this.data.length-this.index>=a}},{key:"read",value:function read(a){for(var b=new Uint8Array(a),c=0;c<a;c+=1)b[c]=this.data[this.index],this.index+=1;return b}},{key:"remuxer",value:function remuxer(b){var c=this;return new Promise(function(d,e){if(!c.recording)return void d();for(c.downloadRate(b.byteLength/1024/1024),c.data=a.mergeBuffer(c.data,b),!c.header.length&&c.readable(13)&&(c.header=c.read(13));c.index<c.data.length;){var f=0,g=0,h=new Uint8Array,i=c.index;if(c.readable(11))h=a.mergeBuffer(h,c.read(11)),g=h[0],f=a.readBufferSum(h.subarray(1,4));else return c.index=i,void d();if(c.readable(f+4)){h=a.mergeBuffer(h,c.read(f));var j=c.read(4);h=a.mergeBuffer(h,j);var k=a.readBufferSum(j);if(k!==f+11)return c.recording=!1,c.notify("视频录制失败，你可以下载已经录制好的部分"),postMessage({type:UPDATE_CONFIG,data:{state:AFTER_RECORD}}),void e(new Error("Prev tag size does not match in tag type: ".concat(g)))}else return c.index=i,void d();if(18===g?c.scripTag=h:(!c.tagStartTime&&(c.tagStartTime=a.getTagTime(h)),c.resultDuration=a.getTagTime(h)-c.tagStartTime,c.videoAndAudioTags=a.mergeBuffer(c.videoAndAudioTags,h)),c.writeRate(h.byteLength/1024/1024),c.sizeRate(c.resultData.byteLength/1024/1024),c.durationRate(c.resultDuration/1e3/60),c.expectedSizeRate(1e3*(60*c.config.maxDuration)*(c.resultData.byteLength/1024/1024/c.resultDuration)),c.resultDuration>=1e3*(60*c.config.maxDuration))return c.recording=!1,c.notify("视频录制完成，可以下载了！"),postMessage({type:UPDATE_CONFIG,data:{state:AFTER_RECORD}}),void d();c.data=c.data.subarray(c.index),c.index=0}d()})}},{key:FLV_BUFFER,value:function value(a){this.recording&&(this.tasks.push(this.remuxer.bind(this,a)),!this.running&&function a(){var b=this,c=this.tasks.shift();c?(this.running=!0,c().then(function(){setTimeout(a.bind(b),0)})):this.running=!1}.call(this))}},{key:START_RECORD,value:function value(b){this.recording=!0,this.config=b,this.recordStartTime=a.getNowTime()}},{key:STOP_RECORD,value:function value(){this.recording=!1}},{key:START_DOWNLOAD,value:function value(){postMessage({type:START_DOWNLOAD,data:URL.createObjectURL(new Blob([this.resultData]))})}},{key:RESET_RECORD,value:function value(){this.data=new Uint8Array,this.header=new Uint8Array,this.scripTag=new Uint8Array,this.videoAndAudioTags=new Uint8Array,this.tagStartTime=0,this.recordStartTime=0,this.resultDuration=0,this.recording=!1,this.config={},this.index=0,this.tasks=[],this.running=!1}},{key:"resultData",get:function get(){return a.mergeBuffer(this.header,this.scripTag,this.videoAndAudioTags)}},{key:"resultSize",get:function get(){return this.header.byteLength+this.scripTag.byteLength+this.videoAndAudioTags.byteLength}}]),a}(),flv=new FLVParser;onmessage=function onmessage(a){var b=a.data,c=b.type,d=b.data;switch(c){case FLV_BUFFER:flv[FLV_BUFFER](d);break;case START_RECORD:flv[START_RECORD](d);break;case STOP_RECORD:flv[STOP_RECORD](d);break;case START_DOWNLOAD:flv[START_DOWNLOAD](d);break;case RESET_RECORD:flv[RESET_RECORD](d);break;default:}};']))),this.storage=new i("bilibili-live-recorder"),this.config=this.storage.get(location.href),this.storage.del(location.href),this.config&&(this.worker.postMessage({type:d,data:this.config}),this.updateConfig(this.config)),this.worker.onmessage=function(t){var r=t.data,a=r.type,n=r.data;switch(a){case y:e.notify(n);break;case g:e.updateConfig(n);break;case l:e.download(n)}},chrome.runtime.onMessage.addListener((function(t,r,a){var n=t.type,i=t.data;switch(n){case u:e.tab=i,a(e.config);break;case d:document.querySelector("video")?(e.storage.set(location.href,i),location.reload()):(e.notify({message:"未找到视频播放器"}),e.updateConfig({state:c}));break;case l:e.updateConfig(i),e.worker.postMessage({type:l});break;case f:e.updateConfig(i),e.worker.postMessage({type:f})}})),window.addEventListener("message",(function(t){if(t.origin===o&&e.config&&e.config.state===s){var r=t.data,a=r.type,n=r.data;switch(a){case h:break;case b:e.worker.postMessage({type:b,data:n})}}}))}return a(r,[{key:"download",value:function(e){!function(e,t){var r=document.createElement("a");r.style.display="none",r.href=e,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}(e,this.config.name+"."+this.config.format),this.updateConfig({state:c})}},{key:"notify",value:function(e){chrome.runtime.sendMessage({type:y,data:e})}},{key:"updateConfig",value:function(t){this.config=function(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?p(a,!0).forEach((function(r){e(t,r,a[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):p(a).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}({},this.config,{},t),chrome.runtime.sendMessage({type:g,data:this.config})}},{key:"injectScript",value:function(){var e=document.createElement("script");e.src=chrome.extension.getURL("injected/index.js"),e.onload=function(){return e.remove()},document.documentElement.appendChild(e)}},{key:"injectStyle",value:function(){var e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.href=chrome.extension.getURL("injected/index.css"),function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise((function(t){return setTimeout(t,e)}))}().then((function(){return document.head.appendChild(e)}))}}]),r}())}));
