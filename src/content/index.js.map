{"version":3,"file":"index.js","sources":["../../node_modules/@babel/runtime/helpers/classCallCheck.js","../../node_modules/@babel/runtime/helpers/createClass.js","../share/index.js","../share/constant.js","dev/index.js"],"sourcesContent":["function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","export function getNowTime() {\n    if (performance && typeof performance.now === 'function') {\n        return performance.now();\n    }\n    return Date.now();\n}\n\nexport function sleep(ms = 0) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport function clamp(num, a, b) {\n    return Math.max(Math.min(num, Math.max(a, b)), Math.min(a, b));\n}\n\nexport function calculationRate(callback) {\n    let totalSize = 0;\n    let lastTime = getNowTime();\n    return size => {\n        totalSize += size;\n        const thisTime = getNowTime();\n        const diffTime = thisTime - lastTime;\n        if (diffTime >= 1000) {\n            callback((totalSize / diffTime) * 1000);\n            lastTime = thisTime;\n            totalSize = 0;\n        }\n    };\n}\n\nexport function mergeBuffer(...buffers) {\n    const Cons = buffers[0].constructor;\n    return buffers.reduce((pre, val) => {\n        const merge = new Cons((pre.byteLength | 0) + (val.byteLength | 0));\n        merge.set(pre, 0);\n        merge.set(val, pre.byteLength | 0);\n        return merge;\n    }, new Cons());\n}\n\nexport function download(url, name) {\n    const elink = document.createElement('a');\n    elink.style.display = 'none';\n    elink.href = url;\n    elink.download = name;\n    document.body.appendChild(elink);\n    elink.click();\n    document.body.removeChild(elink);\n}\n","// 常用\nexport const LIVE = 'https://live.bilibili.com';\nexport const LIVE_PATTERN = '*://*.bilibili.com/*';\nexport const LIVE_ROOM_PATTERN = /^https:\\/\\/live\\.bilibili\\.com/i;\nexport const TITLE_PATTERN = /(\\s-\\s哔哩哔哩直播，二次元弹幕直播平台)|\\s*/g;\nexport const GITHUB = 'https://github.com/zhw2590582/bilibili-live-recorder';\nexport const WEBSTORE = 'https://chrome.google.com/webstore/category/extensions';\n\n// 状态\nexport const BEFORE_RECORD = 'before_record';\nexport const RECORDING = 'recording';\nexport const AFTER_RECORD = 'after_record';\nexport const BEFORE_DOWNLOAD = 'before_download';\nexport const DOWNLOADING = 'downloading';\nexport const AFTER_DOWNLOAD = 'after_download';\n\n// 动作\nexport const TAB_INFO = 'tab_info';\nexport const START_RECORD = 'start_record';\nexport const STOP_RECORD = 'stop_record';\nexport const START_DOWNLOAD = 'start_download';\nexport const UPDATE_CONFIG = 'update_config';\nexport const MP4_BUFFER = 'mp4_buffer';\nexport const FLV_BUFFER = 'flv_buffer';\nexport const NOTIFY = 'notify';\n","import { sleep, download } from '../../share';\nimport {\n    LIVE,\n    NOTIFY,\n    TAB_INFO,\n    MP4_BUFFER,\n    FLV_BUFFER,\n    START_RECORD,\n    STOP_RECORD,\n    UPDATE_CONFIG,\n    START_DOWNLOAD,\n} from '../../share/constant';\n\nclass Content {\n    constructor() {\n        this.injectScript();\n        this.injectStyle();\n\n        this.tab = null;\n        this.config = null;\n        this.worker = new Worker('./flv-remuxer.js');\n\n        // 来自 worker\n        this.worker.onmessage = event => {\n            const { type, data } = event.data;\n            switch (type) {\n                case NOTIFY:\n                    chrome.runtime.sendMessage({\n                        type: NOTIFY,\n                        data,\n                    });\n                    break;\n                case UPDATE_CONFIG:\n                    chrome.runtime.sendMessage({\n                        type: UPDATE_CONFIG,\n                        data,\n                    });\n                    break;\n                case START_DOWNLOAD:\n                    const url = URL.createObjectURL(new Blob([data]));\n                    const name = this.config.name + '.' + this.config.format;\n                    download(url, name);\n                    break;\n                default:\n                    break;\n            }\n        };\n\n        setTimeout(() => {\n            this.notify('hi');\n        }, 1000);\n\n        // 来自 popup\n        chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n            const { type, data } = request;\n            switch (type) {\n                case TAB_INFO:\n                    this.tab = data;\n                    break;\n                case START_RECORD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: START_RECORD,\n                        data,\n                    });\n                    break;\n                case START_DOWNLOAD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: START_DOWNLOAD,\n                        data,\n                    });\n                    break;\n                case STOP_RECORD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: STOP_RECORD,\n                        data,\n                    });\n                    break;\n                default:\n                    break;\n            }\n            sendResponse(this.config);\n        });\n\n        // 来自 injected\n        window.addEventListener('message', event => {\n            if (event.origin !== LIVE) return;\n            const { type, data } = event.data;\n            switch (type) {\n                case MP4_BUFFER:\n                    break;\n                case FLV_BUFFER:\n                    this.worker.postMessage({\n                        type: FLV_BUFFER,\n                        data,\n                    });\n                    break;\n                default:\n                    break;\n            }\n        });\n    }\n\n    injectScript() {\n        const $script = document.createElement('script');\n        $script.src = chrome.extension.getURL('injected/index.js');\n        $script.onload = () => $script.remove();\n        document.documentElement.appendChild($script);\n    }\n\n    injectStyle() {\n        const $style = document.createElement('link');\n        $style.rel = 'stylesheet';\n        $style.type = 'text/css';\n        $style.href = chrome.extension.getURL('injected/index.css');\n        sleep().then(() => document.head.appendChild($style));\n    }\n}\n\nexport default new Content();\n"],"names":["sleep","ms","Promise","resolve","setTimeout","download","url","name","elink","document","createElement","style","display","href","body","appendChild","click","removeChild","LIVE","TAB_INFO","START_RECORD","STOP_RECORD","START_DOWNLOAD","UPDATE_CONFIG","MP4_BUFFER","FLV_BUFFER","NOTIFY","Content","injectScript","injectStyle","tab","config","worker","Worker","URL","onmessage","event","data","type","chrome","runtime","sendMessage","createObjectURL","Blob","format","notify","onMessage","addListener","request","sender","sendResponse","postMessage","window","addEventListener","origin","$script","src","extension","getURL","onload","remove","documentElement","$style","rel","then","head"],"mappings":"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"}