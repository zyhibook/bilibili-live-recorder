{"version":3,"file":"index.js","sources":["../../node_modules/@babel/runtime/helpers/classCallCheck.js","../../node_modules/@babel/runtime/helpers/createClass.js","../share/index.js","../share/constant.js","dev/index.js"],"sourcesContent":["function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","export function notify(text, name) {\n    chrome.notifications.create(String(Math.random()), {\n        type: 'basic',\n        iconUrl: chrome.extension.getURL('icons/icon128.png'),\n        title: chrome.runtime.getManifest().name,\n        message: name || '',\n        contextMessage: text,\n    });\n}\n\nexport function getNowTime() {\n    if (performance && typeof performance.now === 'function') {\n        return performance.now();\n    }\n    return Date.now();\n}\n\nexport function sleep(ms = 0) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport function clamp(num, a, b) {\n    return Math.max(Math.min(num, Math.max(a, b)), Math.min(a, b));\n}\n\nexport function calculationRate(callback) {\n    let totalSize = 0;\n    let lastTime = getNowTime();\n    return size => {\n        totalSize += size;\n        const thisTime = getNowTime();\n        const diffTime = thisTime - lastTime;\n        if (diffTime >= 1000) {\n            callback((totalSize / diffTime) * 1000);\n            lastTime = thisTime;\n            totalSize = 0;\n        }\n    };\n}\n\nexport function mergeBuffer(...buffers) {\n    const Cons = buffers[0].constructor;\n    return buffers.reduce((pre, val) => {\n        const merge = new Cons((pre.byteLength | 0) + (val.byteLength | 0));\n        merge.set(pre, 0);\n        merge.set(val, pre.byteLength | 0);\n        return merge;\n    }, new Cons());\n}\n\nexport function download(url, name) {\n    const elink = document.createElement('a');\n    elink.style.display = 'none';\n    elink.href = url;\n    elink.download = name;\n    document.body.appendChild(elink);\n    elink.click();\n    document.body.removeChild(elink);\n}\n","// 常用\nexport const LIVE = 'https://live.bilibili.com';\nexport const LIVE_PATTERN = '*://*.bilibili.com/*';\nexport const LIVE_ROOM_PATTERN = /^https:\\/\\/live\\.bilibili\\.com\\/\\d+/;\nexport const TITLE_PATTERN = /(\\s-\\s哔哩哔哩直播，二次元弹幕直播平台)|\\s*/g;\nexport const GITHUB = 'https://github.com/zhw2590582/bilibili-live-recorder';\nexport const WEBSTORE = 'https://chrome.google.com/webstore/category/extensions';\n\n// 状态\nexport const BEFORE_RECORD = 'before_record';\nexport const RECORDING = 'recording';\nexport const AFTER_RECORD = 'after_record';\nexport const BEFORE_DOWNLOAD = 'before_download';\nexport const DOWNLOADING = 'downloading';\nexport const AFTER_DOWNLOAD = 'after_download';\n\n// 动作\nexport const TAB_INFO = 'tab_info';\nexport const START_RECORD = 'start_record';\nexport const STOP_RECORD = 'stop_record';\nexport const START_DOWNLOAD = 'start_download';\nexport const UPDATE_CONFIG = 'update_config';\nexport const MP4_BUFFER = 'mp4_buffer';\nexport const FLV_BUFFER = 'flv_buffer';\n\n// 语言\nexport const OPEN_LIVE = '请先打开Bilibili直播间';\nexport const RECORD_CREATED = '录制任务创建成功';\nexport const RECORD_STOP = '录制任务已经停止';\nexport const RECORD_DOWNLOAD = '录制文件开始下载';\nexport const FILE_NAME = '请输入文件名称';\n","import { sleep, download } from '../../share';\nimport {\n    TAB_INFO,\n    LIVE,\n    MP4_BUFFER,\n    FLV_BUFFER,\n    START_RECORD,\n    STOP_RECORD,\n    UPDATE_CONFIG,\n    START_DOWNLOAD,\n} from '../../share/constant';\n\nclass Content {\n    constructor() {\n        this.injectScript();\n        this.injectStyle();\n\n        this.tab = null;\n        this.config = null;\n        this.worker = new Worker('./flv-remuxer.js');\n\n        // 来自 worker\n        this.worker.onmessage = event => {\n            const { type, data } = event.data;\n            switch (type) {\n                case UPDATE_CONFIG:\n                    this.updateConfig(data);\n                    break;\n                case START_DOWNLOAD:\n                    const url = URL.createObjectURL(new Blob([data]));\n                    const name = this.config.name + '.' + this.config.format;\n                    download(url, name);\n                    break;\n                default:\n                    break;\n            }\n        };\n\n        // 来自 popup\n        chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n            const { type, data } = request;\n            switch (type) {\n                case TAB_INFO:\n                    this.tab = data;\n                    break;\n                case START_RECORD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: START_RECORD,\n                        data,\n                    });\n                    break;\n                case START_DOWNLOAD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: START_DOWNLOAD,\n                        data,\n                    });\n                    break;\n                case STOP_RECORD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: STOP_RECORD,\n                        data,\n                    });\n                    break;\n                default:\n                    break;\n            }\n            sendResponse(this.config);\n        });\n\n        // 来自 injected\n        window.addEventListener('message', event => {\n            if (event.origin !== LIVE) return;\n            const { type, data } = event.data;\n            switch (type) {\n                case MP4_BUFFER:\n                    break;\n                case FLV_BUFFER:\n                    this.worker.postMessage({\n                        type: FLV_BUFFER,\n                        data,\n                    });\n                    break;\n                default:\n                    break;\n            }\n        });\n    }\n\n    updateConfig(config) {\n        chrome.runtime.sendMessage({\n            type: UPDATE_CONFIG,\n            data: config,\n        });\n    }\n\n    injectScript() {\n        const $script = document.createElement('script');\n        $script.src = chrome.extension.getURL('injected/index.js');\n        $script.onload = () => $script.remove();\n        document.documentElement.appendChild($script);\n    }\n\n    injectStyle() {\n        const $style = document.createElement('link');\n        $style.rel = 'stylesheet';\n        $style.type = 'text/css';\n        $style.href = chrome.extension.getURL('injected/index.css');\n        sleep().then(() => document.head.appendChild($style));\n    }\n}\n\nexport default new Content();\n"],"names":["sleep","ms","Promise","resolve","setTimeout","download","url","name","elink","document","createElement","style","display","href","body","appendChild","click","removeChild","LIVE","TAB_INFO","START_RECORD","STOP_RECORD","START_DOWNLOAD","UPDATE_CONFIG","MP4_BUFFER","FLV_BUFFER","Content","injectScript","injectStyle","tab","config","worker","Worker","URL","onmessage","event","data","type","updateConfig","createObjectURL","Blob","format","chrome","runtime","onMessage","addListener","request","sender","sendResponse","postMessage","window","addEventListener","origin","sendMessage","$script","src","extension","getURL","onload","remove","documentElement","$style","rel","then","head"],"mappings":"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"}