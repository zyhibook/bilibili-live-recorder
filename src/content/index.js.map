{"version":3,"file":"index.js","sources":["../../node_modules/@babel/runtime/helpers/defineProperty.js","../../node_modules/@babel/runtime/helpers/classCallCheck.js","../../node_modules/@babel/runtime/helpers/createClass.js","../share/index.js","../share/constant.js","dev/index.js"],"sourcesContent":["function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","export function getNowTime() {\n    if (performance && typeof performance.now === 'function') {\n        return performance.now();\n    }\n    return Date.now();\n}\n\nexport function sleep(ms = 0) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport function clamp(num, a, b) {\n    return Math.max(Math.min(num, Math.max(a, b)), Math.min(a, b));\n}\n\nexport function calculationRate(callback) {\n    let totalSize = 0;\n    let lastTime = getNowTime();\n    return size => {\n        totalSize += size;\n        const thisTime = getNowTime();\n        const diffTime = thisTime - lastTime;\n        if (diffTime >= 1000) {\n            callback((totalSize / diffTime) * 1000);\n            lastTime = thisTime;\n            totalSize = 0;\n        }\n    };\n}\n\nexport function mergeBuffer(...buffers) {\n    const Cons = buffers[0].constructor;\n    return buffers.reduce((pre, val) => {\n        const merge = new Cons((pre.byteLength | 0) + (val.byteLength | 0));\n        merge.set(pre, 0);\n        merge.set(val, pre.byteLength | 0);\n        return merge;\n    }, new Cons());\n}\n\nexport function download(url, name) {\n    const elink = document.createElement('a');\n    elink.style.display = 'none';\n    elink.href = url;\n    elink.download = name;\n    document.body.appendChild(elink);\n    elink.click();\n    document.body.removeChild(elink);\n}\n","// 常用\nexport const LIVE = 'https://live.bilibili.com';\nexport const LIVE_PATTERN = '*://*.bilibili.com/*';\nexport const LIVE_ROOM_PATTERN = /^https:\\/\\/live\\.bilibili\\.com/i;\nexport const TITLE_PATTERN = /(\\s-\\s哔哩哔哩直播，二次元弹幕直播平台)|\\s*/g;\nexport const GITHUB = 'https://github.com/zhw2590582/bilibili-live-recorder';\nexport const WEBSTORE = 'https://chrome.google.com/webstore/category/extensions';\n\n// 状态\nexport const BEFORE_RECORD = 'before_record';\nexport const RECORDING = 'recording';\nexport const AFTER_RECORD = 'after_record';\nexport const BEFORE_DOWNLOAD = 'before_download';\nexport const DOWNLOADING = 'downloading';\nexport const AFTER_DOWNLOAD = 'after_download';\n\n// 动作\nexport const TAB_INFO = 'tab_info';\nexport const START_RECORD = 'start_record';\nexport const STOP_RECORD = 'stop_record';\nexport const START_DOWNLOAD = 'start_download';\nexport const UPDATE_CONFIG = 'update_config';\nexport const MP4_BUFFER = 'mp4_buffer';\nexport const FLV_BUFFER = 'flv_buffer';\nexport const NOTIFY = 'notify';\n","import { sleep, download } from '../../share';\nimport {\n    LIVE,\n    NOTIFY,\n    TAB_INFO,\n    MP4_BUFFER,\n    FLV_BUFFER,\n    START_RECORD,\n    BEFORE_RECORD,\n    STOP_RECORD,\n    UPDATE_CONFIG,\n    START_DOWNLOAD,\n} from '../../share/constant';\n\nclass Content {\n    constructor() {\n        this.injectScript();\n        this.injectStyle();\n\n        this.tab = null;\n        this.config = null;\n        this.worker = new Worker('./flv-remuxer.js');\n\n        // 来自 worker\n        this.worker.onmessage = event => {\n            const { type, data } = event.data;\n            switch (type) {\n                case NOTIFY:\n                    this.notify(data);\n                    break;\n                case UPDATE_CONFIG:\n                    this.updateConfig(data);\n                    break;\n                case START_DOWNLOAD:\n                    this.download(data);\n                    break;\n                default:\n                    break;\n            }\n        };\n\n        // 来自 popup\n        chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n            const { type, data } = request;\n            switch (type) {\n                case TAB_INFO:\n                    this.tab = data;\n                    break;\n                case START_RECORD:\n                    this.config = data;\n                    sleep(1000).then(() => {\n                        const $video = document.querySelector('video');\n                        if ($video) {\n                            this.worker.postMessage({\n                                type: START_RECORD,\n                                data,\n                            });\n                        } else {\n                            this.notify({\n                                message: '未找到视频播放器',\n                            });\n                            this.updateConfig({\n                                state: BEFORE_RECORD,\n                            });\n                        }\n                    });\n                    break;\n                case START_DOWNLOAD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: START_DOWNLOAD,\n                        data,\n                    });\n                    break;\n                case STOP_RECORD:\n                    this.config = data;\n                    this.worker.postMessage({\n                        type: STOP_RECORD,\n                        data,\n                    });\n                    break;\n                default:\n                    break;\n            }\n            sendResponse(this.config);\n        });\n\n        // 来自 injected\n        window.addEventListener('message', event => {\n            if (event.origin !== LIVE) return;\n            const { type, data } = event.data;\n            switch (type) {\n                case MP4_BUFFER:\n                    break;\n                case FLV_BUFFER:\n                    this.worker.postMessage({\n                        type: FLV_BUFFER,\n                        data,\n                    });\n                    break;\n                default:\n                    break;\n            }\n        });\n    }\n\n    download(data) {\n        const url = URL.createObjectURL(new Blob([data]));\n        const name = this.config.name + '.' + this.config.format;\n        download(url, name);\n    }\n\n    notify(data) {\n        chrome.runtime.sendMessage({\n            type: NOTIFY,\n            data,\n        });\n    }\n\n    updateConfig(data) {\n        this.config = {\n            ...this.config,\n            ...data,\n        };\n        chrome.runtime.sendMessage({\n            type: UPDATE_CONFIG,\n            data: this.config,\n        });\n    }\n\n    injectScript() {\n        const $script = document.createElement('script');\n        $script.src = chrome.extension.getURL('injected/index.js');\n        $script.onload = () => $script.remove();\n        document.documentElement.appendChild($script);\n    }\n\n    injectStyle() {\n        const $style = document.createElement('link');\n        $style.rel = 'stylesheet';\n        $style.type = 'text/css';\n        $style.href = chrome.extension.getURL('injected/index.css');\n        sleep().then(() => document.head.appendChild($style));\n    }\n}\n\nexport default new Content();\n"],"names":["sleep","ms","Promise","resolve","setTimeout","download","url","name","elink","document","createElement","style","display","href","body","appendChild","click","removeChild","LIVE","BEFORE_RECORD","TAB_INFO","START_RECORD","STOP_RECORD","START_DOWNLOAD","UPDATE_CONFIG","MP4_BUFFER","FLV_BUFFER","NOTIFY","Content","injectScript","injectStyle","tab","config","worker","Worker","URL","onmessage","event","data","type","notify","updateConfig","chrome","runtime","onMessage","addListener","request","sender","sendResponse","then","$video","querySelector","postMessage","message","state","window","addEventListener","origin","createObjectURL","Blob","format","sendMessage","$script","src","extension","getURL","onload","remove","documentElement","$style","rel","head"],"mappings":"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"}