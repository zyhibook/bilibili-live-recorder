{"version":3,"file":"index.js","sources":["../../node_modules/@babel/runtime/helpers/classCallCheck.js","../../node_modules/@babel/runtime/helpers/createClass.js","../share/constant.js","../share/index.js","dev/FlvRemuxer.js","dev/index.js"],"sourcesContent":["function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","export const BILIBILI = 'https://live.bilibili.com';\nexport const GITHUB = 'https://github.com/zhw2590582/bilibili-live-recorder';\nexport const WEBSTORE = 'https://chrome.google.com/webstore/category/extensions';\n\nexport const BEFORE_RECORD = 'before_record';\nexport const START_RECORD = 'start_record';\nexport const RECORDING = 'recording';\nexport const STOP_RECORD = 'stop_record';\nexport const AFTER_RECORD = 'after_record';\n\nexport const BEFORE_DOWNLOAD = 'before_download';\nexport const START_DOWNLOAD = 'start_download';\nexport const DOWNLOADING = 'downloading';\nexport const AFTER_DOWNLOAD = 'after_download';\n\nexport const MP4_BUFFER = 'mp4_buffer';\nexport const FLV_BUFFER = 'flv_buffer';\n\nexport const UPDATE_CONFIG = 'update_config';\n\nexport const TITLE_REPLACE = ' - 哔哩哔哩直播，二次元弹幕直播平台';\nexport const OPEN_LIVE = '请先打开Bilibili直播间';\nexport const RECORD_CREATED = '录制任务创建成功';\nexport const RECORD_STOP = '录制任务已经停止';\nexport const RECORD_DOWNLOAD = '录制文件开始下载！';\n","import { BILIBILI } from './constant';\n\nexport function notify(text, name) {\n    chrome.notifications.create(String(Math.random()), {\n        type: 'basic',\n        iconUrl: chrome.extension.getURL('icons/icon128.png'),\n        title: 'Bilibili 直播间录制器',\n        message: name || '',\n        contextMessage: text,\n    });\n}\n\nexport function badge(text) {\n    chrome.browserAction.setBadgeText({ text: text });\n    chrome.browserAction.setBadgeBackgroundColor({ color: 'red' });\n}\n\nexport function isLiveRoom(url) {\n    const urlObj = new URL(url);\n    const isBilibili = urlObj.origin === BILIBILI;\n    const isRoom = /^\\d+$/.test(urlObj.pathname.slice(1));\n    return isBilibili && isRoom;\n}\n\nexport function getNowTime() {\n    if (performance && typeof performance.now === 'function') {\n        return performance.now();\n    }\n    return Date.now();\n}\n\nexport function sleep(ms = 0) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport function clamp(num, a, b) {\n    return Math.max(Math.min(num, Math.max(a, b)), Math.min(a, b));\n}\n\nexport function calculationRate(callback) {\n    let totalSize = 0;\n    let lastTime = getNowTime();\n    return size => {\n        totalSize += size;\n        const thisTime = getNowTime();\n        const diffTime = thisTime - lastTime;\n        if (diffTime >= 1000) {\n            callback((totalSize / diffTime) * 1000);\n            lastTime = thisTime;\n            totalSize = 0;\n        }\n    };\n}\n\nexport function mergeBuffer(...buffers) {\n    const Cons = buffers[0].constructor;\n    return buffers.reduce((pre, val) => {\n        const merge = new Cons((pre.byteLength | 0) + (val.byteLength | 0));\n        merge.set(pre, 0);\n        merge.set(val, pre.byteLength | 0);\n        return merge;\n    }, new Cons());\n}\n\nexport function download(url, name) {\n    const elink = document.createElement('a');\n    elink.style.display = 'none';\n    elink.href = url;\n    elink.download = name;\n    document.body.appendChild(elink);\n    elink.click();\n    document.body.removeChild(elink);\n}\n","import { mergeBuffer } from '../../share';\n\nexport default class FlvRemuxer {\n    constructor(bg) {\n        this.bg = bg;\n        this.data = new Uint8Array(10);\n    }\n\n    load(buf) {\n        this.data = mergeBuffer(this.data, buf);\n        this.bg.updateConfig({\n            currentSize: (this.data.byteLength / 1024 / 1024).toFixed(3),\n        });\n    }\n\n    stop() {\n        //\n    }\n\n    download() {\n        //\n    }\n}\n","import { sleep } from '../../share';\nimport { BILIBILI, MP4_BUFFER, FLV_BUFFER } from '../../share/constant';\nimport FlvRemuxer from './FlvRemuxer';\n\nclass Content {\n    constructor() {\n        this.injectScript();\n        this.injectStyle();\n        \n        this.config = {};\n        this.flv = new FlvRemuxer(this);\n\n        window.addEventListener('message', event => {\n            if (event.origin !== BILIBILI) return;\n            const { type, data } = event.data;\n            switch (type) {\n                case MP4_BUFFER:\n                    break;\n                case FLV_BUFFER:\n                    this.flv.load(data);\n                    break;\n                default:\n                    break;\n            }\n        });\n\n        chrome.runtime.onMessage.addListener((request, sender, callback) => {\n            const { type, data } = request;\n            switch (type) {\n                case START_RECORD:\n                    this.config = data;\n                    break;\n                case STOP_RECORD:\n                    this.flv.stop();\n                    break;\n                case START_DOWNLOAD:\n                    this.flv.download();\n                default:\n                    break;\n            }\n            callback();\n        });\n    }\n\n    injectScript() {\n        const $script = document.createElement('script');\n        $script.src = chrome.extension.getURL('injected/index.js');\n        $script.onload = () => $script.remove();\n        document.documentElement.appendChild($script);\n    }\n\n    injectStyle() {\n        const $style = document.createElement('link');\n        $style.rel = 'stylesheet';\n        $style.type = 'text/css';\n        $style.href = chrome.extension.getURL('injected/index.css');\n        sleep().then(() => document.head.appendChild($style));\n    }\n}\n\nexport default new Content();\n"],"names":["BILIBILI","MP4_BUFFER","FLV_BUFFER","sleep","ms","Promise","resolve","setTimeout","mergeBuffer","buffers","Cons","constructor","reduce","pre","val","merge","byteLength","set","FlvRemuxer","bg","data","Uint8Array","buf","updateConfig","currentSize","toFixed","Content","injectScript","injectStyle","config","flv","window","addEventListener","event","origin","type","load","chrome","runtime","onMessage","addListener","request","sender","callback","START_RECORD","STOP_RECORD","stop","START_DOWNLOAD","download","$script","document","createElement","src","extension","getURL","onload","remove","documentElement","appendChild","$style","rel","href","then","head"],"mappings":"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"}