{"version":3,"file":"index.js","sources":["../../node_modules/@babel/runtime/helpers/defineProperty.js","../../node_modules/@babel/runtime/helpers/classCallCheck.js","../../node_modules/@babel/runtime/helpers/createClass.js","../share/index.js","../share/storage.js","../share/constant.js","dev/index.js"],"sourcesContent":["function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","export function sleep(ms = 0) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport function clamp(num, a, b) {\n    return Math.max(Math.min(num, Math.max(a, b)), Math.min(a, b));\n}\n\nexport function download(url, name) {\n    const elink = document.createElement('a');\n    elink.style.display = 'none';\n    elink.href = url;\n    elink.download = name;\n    document.body.appendChild(elink);\n    elink.click();\n    document.body.removeChild(elink);\n}\n","export default class Storage {\n    constructor(name) {\n        this.name = name;\n    }\n\n    get(key) {\n        const storage = JSON.parse(window.localStorage.getItem(this.name)) || {};\n        return key ? storage[key] : storage;\n    }\n\n    set(key, value) {\n        const storage = { ...this.get(), [key]: value };\n        window.localStorage.setItem(this.name, JSON.stringify(storage));\n    }\n\n    del(key) {\n        const storage = this.get();\n        delete storage[key];\n        window.localStorage.setItem(this.name, JSON.stringify(storage));\n    }\n\n    clean() {\n        window.localStorage.removeItem(this.name);\n    }\n}\n","// 常用\nexport const LIVE = 'https://live.bilibili.com';\nexport const LIVE_PATTERN = '*://*.bilibili.com/*';\nexport const LIVE_ROOM_PATTERN = /^https:\\/\\/live\\.bilibili\\.com/i;\nexport const TITLE_PATTERN = /(\\s-\\s哔哩哔哩直播，二次元弹幕直播平台)|\\s*/g;\nexport const GITHUB = 'https://github.com/zhw2590582/bilibili-live-recorder';\nexport const WEBSTORE = 'https://chrome.google.com/webstore/detail/nagmkdppcmenlcgelpgkjoknakghllml';\n\n// 状态\nexport const BEFORE_RECORD = 'before_record';\nexport const RECORDING = 'recording';\nexport const AFTER_RECORD = 'after_record';\nexport const DOWNLOADING = 'downloading';\n\n// 动作\nexport const TAB_INFO = 'tab_info';\nexport const START_RECORD = 'start_record';\nexport const STOP_RECORD = 'stop_record';\nexport const START_DOWNLOAD = 'start_download';\nexport const UPDATE_CONFIG = 'update_config';\nexport const MP4_BUFFER = 'mp4_buffer';\nexport const FLV_BUFFER = 'flv_buffer';\nexport const NOTIFY = 'notify';\n","import { sleep, download } from '../../share';\nimport Storage from '../../share/storage';\nimport {\n    LIVE,\n    NOTIFY,\n    TAB_INFO,\n    RECORDING,\n    MP4_BUFFER,\n    FLV_BUFFER,\n    START_RECORD,\n    BEFORE_RECORD,\n    STOP_RECORD,\n    UPDATE_CONFIG,\n    START_DOWNLOAD,\n} from '../../share/constant';\n\nclass Content {\n    constructor() {\n        this.injectScript();\n        this.injectStyle();\n\n        this.tab = null;\n        this.worker = new Worker('./flv-remuxer.js');\n        this.storage = new Storage('bilibili-live-recorder');\n        this.config = this.storage.get(location.href);\n        this.storage.del(location.href);\n\n        if (this.config) {\n            this.worker.postMessage({\n                type: START_RECORD,\n                data: this.config,\n            });\n            this.updateConfig(this.config);\n        }\n\n        // 来自 worker\n        this.worker.onmessage = event => {\n            const { type, data } = event.data;\n            switch (type) {\n                case NOTIFY:\n                    this.notify(data);\n                    break;\n                case UPDATE_CONFIG:\n                    this.updateConfig(data);\n                    break;\n                case START_DOWNLOAD:\n                    this.download(data);\n                    break;\n                default:\n                    break;\n            }\n        };\n\n        // 来自 popup\n        chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {\n            const { type, data } = request;\n            switch (type) {\n                case TAB_INFO:\n                    this.tab = data;\n                    sendResponse(this.config);\n                    break;\n                case START_RECORD:\n                    const $video = document.querySelector('video');\n                    if ($video) {\n                        this.storage.set(location.href, data);\n                        location.reload();\n                    } else {\n                        this.notify({\n                            message: '未找到视频播放器',\n                        });\n                        this.updateConfig({\n                            state: BEFORE_RECORD,\n                        });\n                    }\n                    break;\n                case START_DOWNLOAD:\n                    this.worker.postMessage({\n                        type: START_DOWNLOAD,\n                    });\n                    break;\n                case STOP_RECORD:\n                    this.worker.postMessage({\n                        type: STOP_RECORD,\n                    });\n                    break;\n                default:\n                    break;\n            }\n        });\n\n        // 来自 injected\n        window.addEventListener('message', event => {\n            if (event.origin === LIVE && this.config && this.config.state === RECORDING) {\n                const { type, data } = event.data;\n                switch (type) {\n                    case MP4_BUFFER:\n                        break;\n                    case FLV_BUFFER:\n                        this.worker.postMessage({\n                            type: FLV_BUFFER,\n                            data,\n                        });\n                        break;\n                    default:\n                        break;\n                }\n            }\n        });\n    }\n\n    download(data) {\n        const name = this.config.name + '.' + this.config.format;\n        download(data, name);\n        this.updateConfig({\n            state: BEFORE_RECORD,\n        });\n    }\n\n    notify(data) {\n        chrome.runtime.sendMessage({\n            type: NOTIFY,\n            data,\n        });\n    }\n\n    updateConfig(data) {\n        this.config = {\n            ...this.config,\n            ...data,\n        };\n        chrome.runtime.sendMessage({\n            type: UPDATE_CONFIG,\n            data: this.config,\n        });\n    }\n\n    injectScript() {\n        const $script = document.createElement('script');\n        $script.src = chrome.extension.getURL('injected/index.js');\n        $script.onload = () => $script.remove();\n        document.documentElement.appendChild($script);\n    }\n\n    injectStyle() {\n        const $style = document.createElement('link');\n        $style.rel = 'stylesheet';\n        $style.type = 'text/css';\n        $style.href = chrome.extension.getURL('injected/index.css');\n        sleep().then(() => document.head.appendChild($style));\n    }\n}\n\nexport default new Content();\n"],"names":["sleep","ms","Promise","resolve","setTimeout","download","url","name","elink","document","createElement","style","display","href","body","appendChild","click","removeChild","Storage","key","storage","JSON","parse","window","localStorage","getItem","value","get","setItem","stringify","removeItem","LIVE","BEFORE_RECORD","RECORDING","TAB_INFO","START_RECORD","STOP_RECORD","START_DOWNLOAD","UPDATE_CONFIG","MP4_BUFFER","FLV_BUFFER","NOTIFY","Content","injectScript","injectStyle","tab","worker","Worker","URL","config","location","del","postMessage","type","data","updateConfig","onmessage","event","notify","chrome","runtime","onMessage","addListener","request","sender","sendResponse","$video","querySelector","set","reload","message","state","addEventListener","origin","format","sendMessage","$script","src","extension","getURL","onload","remove","documentElement","$style","rel","then","head"],"mappings":"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"}