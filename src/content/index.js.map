{"version":3,"file":"index.js","sources":["../../node_modules/@babel/runtime/helpers/classCallCheck.js","../../node_modules/@babel/runtime/helpers/createClass.js","../share/constant.js","../share/index.js","../../node_modules/@babel/runtime/helpers/defineProperty.js","../share/storage.js","dev/FlvRemuxer.js","dev/index.js"],"sourcesContent":["function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","export const BILIBILI = 'https://live.bilibili.com';\nexport const GITHUB = 'https://github.com/zhw2590582/bilibili-live-recorder';\nexport const WEBSTORE = 'https://chrome.google.com/webstore/category/extensions';\n\nexport const BEFORE_RECORD = 'before_record';\nexport const START_RECORD = 'start_record';\nexport const RECORDING = 'recording';\nexport const STOP_RECORD = 'stop_record';\nexport const AFTER_RECORD = 'after_record';\n\nexport const BEFORE_DOWNLOAD = 'before_download';\nexport const START_DOWNLOAD = 'start_download';\nexport const DOWNLOADING = 'downloading';\nexport const AFTER_DOWNLOAD = 'after_download';\n\nexport const MP4_BUFFER = 'mp4_buffer';\nexport const FLV_BUFFER = 'flv_buffer';\n\nexport const UPDATE_CONFIG = 'update_config';\n\nexport const TITLE_REPLACE = ' - 哔哩哔哩直播，二次元弹幕直播平台';\nexport const OPEN_LIVE = '请先打开Bilibili直播间';\nexport const RECORD_CREATED = '录制任务创建成功';\nexport const RECORD_STOP = '录制任务已经停止';\nexport const RECORD_DOWNLOAD = '录制文件开始下载！';\n","import { BILIBILI } from './constant';\n\nexport function notify(text, name) {\n    chrome.notifications.create(String(Math.random()), {\n        type: 'basic',\n        iconUrl: chrome.extension.getURL('icons/icon128.png'),\n        title: 'Bilibili 直播间录制器',\n        message: name || '',\n        contextMessage: text,\n    });\n}\n\nexport function badge(text) {\n    chrome.browserAction.setBadgeText({ text: text });\n    chrome.browserAction.setBadgeBackgroundColor({ color: 'red' });\n}\n\nexport function isLiveRoom(url) {\n    const urlObj = new URL(url);\n    const isBilibili = urlObj.origin === BILIBILI;\n    const roomId = urlObj.pathname.slice(1);\n    const isRoom = /^\\d+$/.test(roomId);\n    return isBilibili && isRoom ? roomId : false;\n}\n\nexport function getNowTime() {\n    if (performance && typeof performance.now === 'function') {\n        return performance.now();\n    }\n    return Date.now();\n}\n\nexport function sleep(ms = 0) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport function clamp(num, a, b) {\n    return Math.max(Math.min(num, Math.max(a, b)), Math.min(a, b));\n}\n\nexport function calculationRate(callback) {\n    let totalSize = 0;\n    let lastTime = getNowTime();\n    return size => {\n        totalSize += size;\n        const thisTime = getNowTime();\n        const diffTime = thisTime - lastTime;\n        if (diffTime >= 1000) {\n            callback((totalSize / diffTime) * 1000);\n            lastTime = thisTime;\n            totalSize = 0;\n        }\n    };\n}\n\nexport function mergeBuffer(...buffers) {\n    const Cons = buffers[0].constructor;\n    return buffers.reduce((pre, val) => {\n        const merge = new Cons((pre.byteLength | 0) + (val.byteLength | 0));\n        merge.set(pre, 0);\n        merge.set(val, pre.byteLength | 0);\n        return merge;\n    }, new Cons());\n}\n\nexport function download(url, name) {\n    const elink = document.createElement('a');\n    elink.style.display = 'none';\n    elink.href = url;\n    elink.download = name;\n    document.body.appendChild(elink);\n    elink.click();\n    document.body.removeChild(elink);\n}\n","function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","export default class Storage {\n    get(key, defaultValue) {\n        return new Promise(resolve => {\n            chrome.storage.local.get([String(key)], result => {\n                if (result[key]) {\n                    resolve(result[key]);\n                } else if (defaultValue) {\n                    this.set(key, defaultValue).then(value => {\n                        resolve(value);\n                    });\n                } else {\n                    resolve();\n                }\n            });\n        });\n    }\n\n    set(key, value) {\n        return new Promise(resolve => {\n            chrome.storage.local.set(\n                {\n                    [key]: value,\n                },\n                () => {\n                    resolve(value);\n                },\n            );\n        });\n    }\n\n    remove(key) {\n        chrome.storage.local.remove(String(key));\n    }\n\n    onChanged(key, callback) {\n        chrome.storage.onChanged.addListener(changes => {\n            if (changes[key] && changes[key].newValue) {\n                callback(changes[key].newValue);\n            }\n        });\n    }\n}\n","import { mergeBuffer } from '../../share';\n\nexport default class FlvRemuxer {\n    constructor(bg) {\n        this.bg = bg;\n        this.data = new Uint8Array(10);\n    }\n\n    load(buf) {\n        //\n    }\n\n    stop() {\n        //\n    }\n\n    download() {\n        //\n    }\n}\n","import { sleep, isLiveRoom } from '../../share';\nimport Storage from '../../share/storage';\nimport { BILIBILI, MP4_BUFFER, FLV_BUFFER } from '../../share/constant';\nimport FlvRemuxer from './FlvRemuxer';\n\nclass Content {\n    constructor() {\n        this.injectScript();\n        this.injectStyle();\n\n        this.config = {};\n        this.storage = new Storage();\n        this.flv = new FlvRemuxer(this);\n        this.roomId = isLiveRoom(location.href);\n\n        if (this.roomId) {\n            this.storage.get(this.roomId).then(config => {\n                if (config) {\n                    this.config = config;\n                }\n            });\n\n            this.storage.onChanged(this.roomId, config => {\n                this.config = config;\n            });\n\n            window.addEventListener('beforeunload', () => {\n                this.storage.remove(this.roomId);\n            });\n        }\n\n        window.addEventListener('message', event => {\n            if (event.origin !== BILIBILI) return;\n            const { type, data } = event.data;\n            switch (type) {\n                case MP4_BUFFER:\n                    break;\n                case FLV_BUFFER:\n                    // this.flv.load(data);\n                    break;\n                default:\n                    break;\n            }\n        });\n    }\n\n    injectScript() {\n        const $script = document.createElement('script');\n        $script.src = chrome.extension.getURL('injected/index.js');\n        $script.onload = () => $script.remove();\n        document.documentElement.appendChild($script);\n    }\n\n    injectStyle() {\n        const $style = document.createElement('link');\n        $style.rel = 'stylesheet';\n        $style.type = 'text/css';\n        $style.href = chrome.extension.getURL('injected/index.css');\n        sleep().then(() => document.head.appendChild($style));\n    }\n}\n\nexport default new Content();\n"],"names":["BILIBILI","isLiveRoom","url","urlObj","URL","isBilibili","origin","roomId","pathname","slice","isRoom","test","sleep","ms","Promise","resolve","setTimeout","Storage","key","defaultValue","chrome","storage","local","get","String","result","set","then","value","remove","callback","onChanged","addListener","changes","newValue","FlvRemuxer","bg","data","Uint8Array","buf","Content","injectScript","injectStyle","config","flv","location","href","window","addEventListener","event","type","$script","document","createElement","src","extension","getURL","onload","documentElement","appendChild","$style","rel","head"],"mappings":"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"}