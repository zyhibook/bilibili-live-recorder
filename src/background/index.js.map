{"version":3,"file":"index.js","sources":["../../node_modules/@babel/runtime/helpers/classCallCheck.js","../../node_modules/@babel/runtime/helpers/createClass.js","../../node_modules/crx-hotreload/hot-reload.js","../share/constant.js","dev/index.js"],"sourcesContent":["function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","const filesInDirectory = dir => new Promise (resolve =>\n\n    dir.createReader ().readEntries (entries =>\n\n        Promise.all (entries.filter (e => e.name[0] !== '.').map (e =>\n\n            e.isDirectory\n                ? filesInDirectory (e)\n                : new Promise (resolve => e.file (resolve))\n        ))\n        .then (files => [].concat (...files))\n        .then (resolve)\n    )\n)\n\nconst timestampForFilesInDirectory = dir =>\n        filesInDirectory (dir).then (files =>\n            files.map (f => f.name + f.lastModifiedDate).join ())\n\nconst reload = () => {\n\n    chrome.tabs.query ({ active: true, currentWindow: true }, tabs => { // NB: see https://github.com/xpl/crx-hotreload/issues/5\n\n        if (tabs[0]) { chrome.tabs.reload (tabs[0].id) }\n\n        chrome.runtime.reload ()\n    })\n}\n\nconst watchChanges = (dir, lastTimestamp) => {\n\n    timestampForFilesInDirectory (dir).then (timestamp => {\n\n        if (!lastTimestamp || (lastTimestamp === timestamp)) {\n\n            setTimeout (() => watchChanges (dir, timestamp), 1000) // retry after 1s\n\n        } else {\n\n            reload ()\n        }\n    })\n\n}\n\nchrome.management.getSelf (self => {\n\n    if (self.installType === 'development') {\n\n        chrome.runtime.getPackageDirectoryEntry (dir => watchChanges (dir))\n    }\n})\n","// 常用\nexport const LIVE = 'https://live.bilibili.com';\nexport const LIVE_PATTERN = '*://*.bilibili.com/*';\nexport const LIVE_ROOM_PATTERN = /^https:\\/\\/live\\.bilibili\\.com/i;\nexport const TITLE_PATTERN = /(\\s-\\s哔哩哔哩直播，二次元弹幕直播平台)|\\s*/g;\nexport const GITHUB = 'https://github.com/zhw2590582/bilibili-live-recorder';\nexport const WEBSTORE = 'https://chrome.google.com/webstore/detail/nagmkdppcmenlcgelpgkjoknakghllml';\n\n// 状态\nexport const BEFORE_RECORD = 'before_record';\nexport const RECORDING = 'recording';\nexport const AFTER_RECORD = 'after_record';\nexport const DOWNLOADING = 'downloading';\n\n// 动作\nexport const TAB_INFO = 'tab_info';\nexport const START_RECORD = 'start_record';\nexport const STOP_RECORD = 'stop_record';\nexport const START_DOWNLOAD = 'start_download';\nexport const UPDATE_CONFIG = 'update_config';\nexport const MP4_BUFFER = 'mp4_buffer';\nexport const FLV_BUFFER = 'flv_buffer';\nexport const NOTIFY = 'notify';\n","import 'crx-hotreload';\nimport { LIVE_PATTERN, NOTIFY } from '../../share/constant';\n\nclass Background {\n    constructor() {\n        this.changeCSP();\n\n        // 来自 content\n        chrome.runtime.onMessage.addListener(request => {\n            const { type, data } = request;\n            switch (type) {\n                case NOTIFY:\n                    chrome.notifications.create(String(Math.random()), {\n                        type: 'basic',\n                        message: data.message,\n                        contextMessage: data.title || '',\n                        title: chrome.runtime.getManifest().name,\n                        iconUrl: chrome.extension.getURL('icons/icon128.png'),\n                    });\n                    break;\n                default:\n                    break;\n            }\n        });\n\n        // 点击关闭提示\n        chrome.notifications.onClicked.addListener(id => {\n            chrome.notifications.clear(id);\n        });\n    }\n\n    // 设置小图标文字\n    setBadgeText(tabId, text, color = 'red') {\n        chrome.browserAction.setBadgeText({ text, tabId });\n        chrome.browserAction.setBadgeBackgroundColor({ color });\n    }\n\n    // 修改CSP响应头\n    changeCSP() {\n        chrome.webRequest.onHeadersReceived.addListener(\n            details => {\n                let header = details.responseHeaders.find(\n                    e => e.name.toLowerCase() === 'content-security-policy-report-only',\n                );\n                if (header && header.value) {\n                    header.value = 'worker-src blob: ; ' + header.value;\n                }\n                return { responseHeaders: details.responseHeaders };\n            },\n            { urls: [LIVE_PATTERN] },\n            ['blocking', 'responseHeaders'],\n        );\n    }\n}\n\nexport default new Background();\n"],"names":["LIVE_PATTERN","NOTIFY","Background","changeCSP","chrome","runtime","onMessage","addListener","request","type","data","notifications","create","String","Math","random","message","contextMessage","title","getManifest","name","iconUrl","extension","getURL","onClicked","id","clear","tabId","text","color","browserAction","setBadgeText","setBadgeBackgroundColor","webRequest","onHeadersReceived","details","header","responseHeaders","find","e","toLowerCase","value","urls"],"mappings":"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"}